services:
  starter:
    image: curlimages/curl:8.10.1
    depends_on:
      postgres:
        condition: service_healthy
      litellm:
        condition: service_healthy
    command: echo "All services started successfully"
    networks:
      - litellm-network

  postgres:
    image: postgres:17.2-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-litellm}
      - POSTGRES_USER=${POSTGRES_USER:-litellm_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-litellm_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-litellm_user}']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - litellm-network

  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    ports:
      - '4000:4000'
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-1234}
      - LITELLM_SALT_KEY=${LITELLM_SALT_KEY:-sk-5678}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-litellm_user}:${POSTGRES_PASSWORD:-litellm_password}@postgres:5432/${POSTGRES_DB:-litellm}
    volumes:
      - ./litellm-config.yaml:/app/config.yaml:ro
    command: ['--config', '/app/config.yaml', '--port', '4000']
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'python',
          '-c',
          'import socket; s = socket.socket(); s.connect(("localhost", 4000)); s.close()',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - litellm-network

networks:
  litellm-network:
    driver: bridge

volumes:
  postgres-data:
